config.raw_apk = 'bin/Android-Autostarts-release.apk'


import time
from os import path, unlink


def build():
    # build the app
    local('ant release')
    

@depends(build)
def version():
    
    # determine the version number
    import subprocess, re
    manifest = subprocess.Popen(
        ["aapt", "dump", "xmltree", config.raw_apk, "AndroidManifest.xml"],
        stdout=subprocess.PIPE).communicate()[0]
    config.version = version = re.search(r'^\s*A: android:versionName\([^)]+\)="([^"]+)" \(Raw: "[^"]+"\)\s*$', manifest, re.M).groups()[0]    
    # add version number to file name
    base, ext = path.splitext(config.raw_apk)
    config.target_apk = '%s-%s%s' % (base, version, ext)

    # move to final location
    local('mv $(raw_apk) $(target_apk)')
    

@depends(version)
def make():
    # Create an .ini section for our site
    base, ext = path.splitext(config.target_apk)    
    ini = open('%s.ini' % base, 'w')
    ini.write("[%s]\n" % config.version)
    ini.write("version=%s\n" % config.version)
    ini.write("timestamp=%s\n" % int(time.time()))
    ini.write("size_apk=%s\n" % path.getsize(config.target_apk))
    ini.close()
    pass


@depends(make)
def deploy():
    pass
